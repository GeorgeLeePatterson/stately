name: CI

concurrency:
  group: ${{ github.repository }}-${{ github.head_ref || github.sha }}-${{ github.workflow }}
  cancel-in-progress: true

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  checks: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RUSTFLAGS: '-C debuginfo=line-tables-only -C incremental=false'

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      rust: ${{ steps.changes.outputs.rust }}
      typescript: ${{ steps.changes.outputs.typescript }}
    steps:
    - uses: actions/checkout@v5
    - uses: dorny/paths-filter@master
      id: changes
      with:
        filters: |
          rust:
            - 'crates/**'
            - 'Cargo.toml'
            - 'Cargo.lock'
            - 'rustfmt.toml'
          typescript:
            - 'packages/**'
            - 'package.json'
            - 'pnpm-lock.yaml'
            - 'pnpm-workspace.yaml'
            - 'turbo.json'
            - 'tsconfig.base.json'

  check:
    name: Rust Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    steps:
    - uses: actions/checkout@v5

    - name: Install Rust stable
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy

    - name: Install Rust nightly (for formatting)
      uses: dtolnay/rust-toolchain@nightly
      with:
        components: rustfmt

    - name: Check formatting
      run: cargo +nightly fmt -- --check

    - name: Run clippy
      run: cargo +stable clippy --profile ci --all-features --all-targets -- -D warnings

    - name: Build stable
      run: cargo +stable build --profile ci --all-features --verbose

  coverage:
    name: Rust Coverage
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    steps:
    - uses: actions/checkout@v5

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install cargo-llvm-cov
      uses: taiki-e/install-action@cargo-llvm-cov

    - name: Generate code coverage
      run: |
        cargo llvm-cov --lcov \
         --ignore-filename-regex "(errors|examples|stately-derive).*" \
         --output-path lcov.info -F axum

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: lcov.info
        fail_ci_if_error: true
        disable_telem: true

  typescript:
    name: TypeScript Build & Test
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.typescript == 'true'
    steps:
    - uses: actions/checkout@v5

    - name: Install pnpm
      uses: pnpm/action-setup@v4

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'pnpm'

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Type check
      run: pnpm run check

    - name: Build
      run: pnpm run build

    - name: Test
      run: pnpm run test

  # Summary job that branch protection can depend on
  ci-success:
    name: CI Success
    needs: [changes, check, coverage, typescript]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check if all jobs succeeded
        run: |
          # Check if either Rust or TypeScript changed
          rust_changed="${{ needs.changes.outputs.rust }}"
          ts_changed="${{ needs.changes.outputs.typescript }}"

          # Get job results
          check_result="${{ needs.check.result }}"
          coverage_result="${{ needs.coverage.result }}"
          typescript_result="${{ needs.typescript.result }}"

          echo "Change detection: rust=$rust_changed, typescript=$ts_changed"
          echo "Job results: check=$check_result, coverage=$coverage_result, typescript=$typescript_result"

          # If nothing changed, all jobs should be skipped - that's success
          if [[ "$rust_changed" == "false" && "$ts_changed" == "false" ]]; then
            echo "No code changes detected ‚úÖ"
            exit 0
          fi

          # Check Rust jobs if Rust changed
          if [[ "$rust_changed" == "true" ]]; then
            if [[ "$check_result" != "success" ]]; then
              echo "Rust Check job failed (result: $check_result) ‚ùå"
              exit 1
            fi
            if [[ "$coverage_result" != "success" ]]; then
              echo "Rust Coverage job failed (result: $coverage_result) ‚ùå"
              exit 1
            fi
            echo "Rust CI jobs passed ‚úÖ"
          fi

          # Check TypeScript jobs if TypeScript changed
          if [[ "$ts_changed" == "true" ]]; then
            if [[ "$typescript_result" != "success" ]]; then
              echo "TypeScript job failed (result: $typescript_result) ‚ùå"
              exit 1
            fi
            echo "TypeScript CI jobs passed ‚úÖ"
          fi

          echo "All CI jobs passed successfully! üéâ"
